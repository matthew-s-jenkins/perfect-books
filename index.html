<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Perfect Books</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@17/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@17/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body class="bg-gray-900 text-gray-200 font-sans">
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useEffect } = React;
        const API_BASE_URL = 'http://127.0.0.1:5000';
        
        const fetchWithCredentials = (url, options = {}) => {
            return fetch(url, { ...options, credentials: 'include' });
        };
        
        // --- UTILITY FUNCTION ---
        const categorizeAccount = (accountName, accountTypeMap) => {
            const type = accountTypeMap.get(accountName);
            const name = accountName.toLowerCase();

            if (type === 'CREDIT_CARD' || type === 'LOAN' || name.includes('mortgage')) return 'liability';
            if (name === 'system') return 'system';
            if (name.includes('equity') || name.includes('capital') || name.includes('retained')) return 'equity';
            if (name.includes('income') || name.includes('revenue') || name.includes('sales')) return 'income';
            if (name.includes('expenses') || name.includes('expense') || name.includes('cost')) return 'expense';
            
            return 'asset';
        };

        // --- CHILD COMPONENTS ---

        function LoadingSpinner({ text = 'Loading...' }) {
            return (
                <div className="flex flex-col items-center justify-center min-h-screen">
                    <div className="animate-spin rounded-full h-16 w-16 border-b-4 border-cyan-500 mb-4"></div>
                    <p className="text-gray-400 text-lg">{text}</p>
                </div>
            );
        }

        function Toast({ message, type, onClose }) {
            const bgColor = type === 'error' ? 'bg-red-600' : type === 'success' ? 'bg-green-600' : 'bg-blue-600';

            useEffect(() => {
                const timer = setTimeout(() => {
                    onClose();
                }, 5000);
                return () => clearTimeout(timer);
            }, [onClose]);

            return (
                <div className={`fixed top-20 right-8 ${bgColor} text-white px-6 py-3 rounded-lg shadow-lg z-50 max-w-md`}>
                    <div className="flex items-center justify-between">
                        <span className="text-sm">{message}</span>
                        <button onClick={onClose} className="ml-4 text-white hover:text-gray-200 font-bold">✕</button>
                    </div>
                </div>
            );
        }

        function Header({ status, onTimeAdvanced, username, showToast }) {
            const formattedDate = status ? 
                new Date(status.date).toLocaleDateString('en-US', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                }) : '...';

            const handleLogout = async () => {
                await fetchWithCredentials(`${API_BASE_URL}/api/logout`, { method: 'POST' });
                window.location.href = 'login.html';
            };

            return (
                <header className="bg-gray-800 shadow rounded-lg p-4 mb-6">
                    <div className="flex justify-between items-start">
                        <div>
                            <h1 className="text-3xl font-bold text-white">Perfect Books</h1>
                            <p className="text-gray-400">Personal Finance Manager</p>
                        </div>
                        <div className="text-right">
                            <p className="text-lg font-medium text-white">{formattedDate}</p>
                            <p className="text-xs text-gray-500 mb-2">Current Date</p>
                            {username && (
                                <div className="text-xs text-gray-400">
                                    <span className="font-medium text-cyan-400">{username}</span>
                                    <button
                                        onClick={handleLogout}
                                        className="ml-2 font-medium text-red-500 hover:text-red-400 hover:underline focus:outline-none"
                                    >
                                        (logout)
                                    </button>
                                </div>
                            )}
                        </div>
                    </div>
                    <AdvanceTime onTimeAdvanced={onTimeAdvanced} showToast={showToast} />
                </header>
            );
        }

        function AdvanceTime({ onTimeAdvanced, showToast }) {
            const [isAdvancing, setIsAdvancing] = useState(false);
            const handleAdvance = async () => {
                setIsAdvancing(true);
                try {
                    const response = await fetchWithCredentials(`${API_BASE_URL}/api/advance_time`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ days: 1 }),
                    });
                    if (response.ok) {
                        const result = await response.json();
                        showToast('Time advanced successfully', 'success');
                        onTimeAdvanced();
                    } else {
                        const error = await response.json();
                        showToast(error.message || 'Failed to advance time', 'error');
                    }
                } catch (err) {
                    showToast('Error advancing time: ' + err.message, 'error');
                } finally {
                    setIsAdvancing(false);
                }
            };
            return (
                <div className="mt-4 border-t border-dashed border-gray-600 pt-4">
                    <div className="flex items-center justify-between">
                        <div>
                            <h3 className="text-sm font-medium text-amber-400">Testing Feature</h3>
                            <p className="text-xs text-gray-500">Advance time will be removed for final version.</p>
                        </div>
                        <button
                            onClick={handleAdvance}
                            disabled={isAdvancing}
                            className="bg-indigo-600 hover:bg-indigo-500 text-white font-bold py-2 px-4 rounded-md disabled:bg-gray-500 disabled:cursor-not-allowed flex items-center"
                        >
                            {isAdvancing && (
                                <svg className="animate-spin -ml-1 mr-2 h-4 w-4 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                    <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
                                    <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                </svg>
                            )}
                            {isAdvancing ? 'Advancing...' : 'Advance 1 Day'}
                        </button>
                    </div>
                </div>
            );
        }

        function Meter({ meterData, averageData }) {
            const { daily_burn_rate } = meterData;
            const formattedGoal = daily_burn_rate.toLocaleString('en-US', { style: 'currency', currency: 'USD' });

            const avgNetProgress = averageData ? averageData.average - daily_burn_rate : 0;
            const isAvgAhead = avgNetProgress >= 0;
            const avgColorClass = isAvgAhead ? 'text-green-400' : 'text-red-400';
            const formattedAvgProgress = Math.abs(avgNetProgress).toLocaleString('en-US', { style: 'currency', currency: 'USD' });
            const avgStatusText = isAvgAhead ? 'Ahead of' : 'Behind';

            return (
                <div className="bg-gray-800 shadow rounded-lg p-6 mb-6">
                    <h2 className="text-lg font-medium text-gray-300 mb-2">Progress Meter</h2>
                    {averageData && averageData.days_with_data > 0 ? (
                        <div>
                            <h3 className="text-sm font-medium text-gray-400 mb-2">{averageData.days_with_data}-Day Average</h3>
                            <div className="flex items-baseline">
                                <p className={`text-4xl font-bold ${avgColorClass}`}>{formattedAvgProgress}</p>
                                <p className="ml-2 text-gray-400">{avgStatusText} Goal</p>
                            </div>
                            <p className="text-xs text-gray-500 mt-1">Avg daily net: {averageData.average.toLocaleString('en-US', { style: 'currency', currency: 'USD' })}</p>
                        </div>
                    ) : (
                        <p className="text-gray-400">No transaction data yet. Start logging income and expenses to see your progress.</p>
                    )}
                    <p className="text-sm text-gray-500 mt-4 pt-4 border-t border-gray-700">Your daily goal is to net {formattedGoal} to cover recurring expenses.</p>
                </div>
            );
        }

        function BalanceSheetSummary({ accounts }) {
            const accountTypeMap = new Map();
            accounts.forEach(acc => {
                accountTypeMap.set(acc.name, acc.type);
            });
            
            const totals = accounts.reduce((acc, account) => {
                const category = categorizeAccount(account.name, accountTypeMap);
                // Ignore the special 'equity' account in this summary calculation
                if (category !== 'equity') {
                    const balance = parseFloat(account.balance);
                    if (category === 'asset') acc.assets += balance;
                    if (category === 'liability') acc.liabilities += balance;
                }
                return acc;
            }, { assets: 0, liabilities: 0 });

            // Equity = Assets - Liabilities
            totals.equity = totals.assets - totals.liabilities;

            // Check if the accounting equation balances: Assets = Liabilities + Equity
            const rightSide = totals.liabilities + totals.equity;
            const isBalanced = Math.abs(totals.assets - rightSide) < 0.01;

            return (
                <div className="bg-gray-800 shadow rounded-lg p-4 mb-6">
                    <h2 className="text-sm font-medium text-gray-300 mb-3">Balance Sheet Check (Assets = Liabilities + Equity)</h2>
                    <div className="flex items-center justify-around text-center font-mono">
                        <div className="w-1/4">
                            <p className="text-xs text-gray-500">Total Assets</p>
                            <p className="text-lg text-green-400">{totals.assets.toLocaleString('en-US', {style: 'currency', currency: 'USD'})}</p>
                        </div>
                        <div className="text-2xl text-gray-600">=</div>
                         <div className="w-1/4">
                            <p className="text-xs text-gray-500">Total Liabilities</p>
                            <p className="text-lg text-red-400">{totals.liabilities.toLocaleString('en-US', {style: 'currency', currency: 'USD'})}</p>
                        </div>
                        <div className="text-2xl text-gray-600">+</div>
                        <div className="w-1/4">
                            <p className="text-xs text-gray-500">Total Equity</p>
                            <p className="text-lg text-cyan-400">{totals.equity.toLocaleString('en-US', {style: 'currency', currency: 'USD'})}</p>
                        </div>
                        <div className="w-1/4 pl-4 border-l border-gray-700">
                             <p className="text-xs text-gray-500">Result</p>
                             <p className={`text-lg font-bold ${isBalanced ? 'text-green-400' : 'text-red-400'}`}>
                                {isBalanced ? 'Balanced' : 'Error'}
                            </p>
                        </div>
                    </div>
                </div>
            );
        }

        function AccountsList({ accounts, onDataChange, showToast }) {
            const [revaluingAccount, setRevaluingAccount] = useState(null);
            const [newValue, setNewValue] = useState('');
            const [revalueDescription, setRevalueDescription] = useState('Asset Revaluation');

            const handleDelete = async (accountId, accountName) => {
                if (!confirm(`Are you sure you want to delete "${accountName}"? This cannot be undone.`)) return;

                try {
                    const response = await fetchWithCredentials(`${API_BASE_URL}/api/account/${accountId}`, {
                        method: 'DELETE'
                    });
                    const result = await response.json();
                    if (result.success) {
                        showToast(result.message, 'success');
                        onDataChange();
                    } else {
                        showToast(result.message, 'error');
                    }
                } catch (err) {
                    showToast('Error deleting account: ' + err.message, 'error');
                }
            };

            const handleRevalue = async (accountId) => {
                try {
                    const response = await fetchWithCredentials(`${API_BASE_URL}/api/revalue_asset`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            account_id: accountId,
                            new_value: parseFloat(newValue),
                            description: revalueDescription
                        })
                    });
                    const result = await response.json();
                    if (result.success) {
                        showToast(result.message, 'success');
                        setRevaluingAccount(null);
                        setNewValue('');
                        setRevalueDescription('Asset Revaluation');
                        onDataChange();
                    } else {
                        showToast(result.message, 'error');
                    }
                } catch (err) {
                    showToast('Error revaluing asset: ' + err.message, 'error');
                }
            };

            return (
                <div className="bg-gray-800 shadow rounded-lg p-4">
                    <div className="flex justify-between items-center mb-4">
                        <h2 className="text-xl font-bold text-white">Your Accounts</h2>
                        <a href="setup.html" className="text-cyan-400 hover:text-cyan-300 text-sm">+ Add Account</a>
                    </div>
                    <table className="min-w-full divide-y divide-gray-700">
                        <thead className="bg-gray-700">
                            <tr>
                                <th className="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Account Name</th>
                                <th className="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Type</th>
                                <th className="px-6 py-3 text-right text-xs font-medium text-gray-300 uppercase tracking-wider">Balance</th>
                                <th className="px-6 py-3 text-center text-xs font-medium text-gray-300 uppercase tracking-wider">Actions</th>
                            </tr>
                        </thead>
                        <tbody className="bg-gray-800 divide-y divide-gray-700">
                            {accounts.map(account => (
                                <React.Fragment key={account.account_id}>
                                    <tr>
                                        <td className="px-6 py-4 whitespace-nowrap text-sm text-white">{account.name}</td>
                                        <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-400">{account.type}</td>
                                        <td className="px-6 py-4 whitespace-nowrap text-sm text-right font-mono text-cyan-400">
                                            {parseFloat(account.balance).toLocaleString('en-US', { style: 'currency', currency: 'USD' })}
                                        </td>
                                        <td className="px-6 py-4 whitespace-nowrap text-sm text-center space-x-2">
                                            {account.type === 'FIXED_ASSET' && (
                                                <button
                                                    onClick={() => {
                                                        setRevaluingAccount(account);
                                                        setNewValue(account.balance);
                                                    }}
                                                    className="text-cyan-400 hover:text-cyan-300 text-xs"
                                                    title="Revalue this asset"
                                                >
                                                    Revalue
                                                </button>
                                            )}
                                            <button
                                                onClick={() => handleDelete(account.account_id, account.name)}
                                                className="text-red-400 hover:text-red-300 text-xs"
                                                title="Delete account (must have $0 balance)"
                                            >
                                                Delete
                                            </button>
                                        </td>
                                    </tr>
                                    {revaluingAccount && revaluingAccount.account_id === account.account_id && (
                                        <tr>
                                            <td colSpan="4" className="px-6 py-4 bg-gray-750">
                                                <div className="flex items-end space-x-4">
                                                    <div>
                                                        <label className="block text-xs text-gray-400 mb-1">New Value</label>
                                                        <div className="relative">
                                                            <span className="absolute left-2 top-2 text-gray-400">$</span>
                                                            <input
                                                                type="number"
                                                                step="0.01"
                                                                value={newValue}
                                                                onChange={(e) => setNewValue(e.target.value)}
                                                                className="bg-gray-700 text-white p-2 pl-6 rounded w-40"
                                                                placeholder="0.00"
                                                                required
                                                            />
                                                        </div>
                                                    </div>
                                                    <div className="flex-1">
                                                        <label className="block text-xs text-gray-400 mb-1">Description</label>
                                                        <input
                                                            type="text"
                                                            value={revalueDescription}
                                                            onChange={(e) => setRevalueDescription(e.target.value)}
                                                            className="bg-gray-700 text-white p-2 rounded w-full"
                                                        />
                                                    </div>
                                                    <div>
                                                        <button
                                                            onClick={() => handleRevalue(account.account_id)}
                                                            className="bg-cyan-600 hover:bg-cyan-500 text-white px-4 py-2 rounded text-xs"
                                                        >
                                                            Save
                                                        </button>
                                                        <button
                                                            onClick={() => {
                                                                setRevaluingAccount(null);
                                                                setNewValue('');
                                                                setRevalueDescription('Asset Revaluation');
                                                            }}
                                                            className="bg-gray-600 hover:bg-gray-500 text-white px-4 py-2 rounded text-xs ml-2"
                                                        >
                                                            Cancel
                                                        </button>
                                                    </div>
                                                </div>
                                            </td>
                                        </tr>
                                    )}
                                </React.Fragment>
                            ))}
                        </tbody>
                    </table>
                </div>
            );
        }

        function LedgerView({ ledger, accounts, categories, onDataChange, showToast }) {
            const [editingCategory, setEditingCategory] = useState(null);
            const [selectedCategoryId, setSelectedCategoryId] = useState('');

            const accountTypeMap = new Map();
            accounts.forEach(acc => {
                accountTypeMap.set(acc.name, acc.type);
            });

            const handleCategoryUpdate = async (transactionUuid) => {
                try {
                    const response = await fetchWithCredentials(`${API_BASE_URL}/api/expense/category`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            transaction_uuid: transactionUuid,
                            category_id: selectedCategoryId || null
                        })
                    });
                    const result = await response.json();
                    if (result.success) {
                        showToast('Category updated', 'success');
                        setEditingCategory(null);
                        onDataChange();
                    } else {
                        showToast(result.message, 'error');
                    }
                } catch (err) {
                    showToast('Error updating category', 'error');
                }
            };

            const handleReverse = async (transactionUuid, description) => {
                if (!confirm(`Are you sure you want to reverse this transaction?\n\n"${description}"\n\nThis will create a reversal entry in the ledger.`)) return;

                try {
                    const response = await fetchWithCredentials(`${API_BASE_URL}/api/reverse_transaction`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ transaction_uuid: transactionUuid })
                    });
                    const result = await response.json();
                    if (result.success) {
                        showToast(result.message, 'success');
                        onDataChange();
                    } else {
                        showToast(result.message, 'error');
                    }
                } catch (err) {
                    showToast('Error reversing transaction: ' + err.message, 'error');
                }
            };

            const groupedTransactions = ledger.reduce((acc, entry) => {
                const uuid = entry.transaction_uuid || `${entry.transaction_date}_${entry.description}`;
                if (!acc[uuid]) {
                    acc[uuid] = { date: entry.transaction_date, entries: [], description: entry.description };
                }
                acc[uuid].entries.push(entry);
                if (entry.description && !['Time Advanced', 'Initial Balance'].includes(entry.description)) {
                    acc[uuid].description = entry.description;
                }
                return acc;
            }, {});

            const transactions = Object.values(groupedTransactions)
                .filter(t => t.description !== 'Time Advanced') // <-- This is the fix
                .sort((a, b) => new Date(b.date) - new Date(a.date));

            const getAccountDisplay = (account, amount, isDebit) => {
                const category = categorizeAccount(account, accountTypeMap);
                let effect = (category === 'asset' || category === 'expense') ? (isDebit ? '↑' : '↓') : (isDebit ? '↓' : '↑');
                return { account, amount, effect, category };
            };

            const renderImpact = (value, category) => {
                if (!value || value === 0) return <span className="text-gray-600">—</span>;

                // Color based purely on equation direction: positive = green, negative = red
                const color = value > 0 ? 'text-green-400' : 'text-red-400';
                const sign = value > 0 ? '+' : '';
                return <span className={color}>{sign}{value.toLocaleString('en-US', { style: 'currency', currency: 'USD', minimumFractionDigits: 0, maximumFractionDigits: 0 })}</span>;
            };

            return (
                <div className="bg-gray-800 shadow rounded-lg p-4 mt-6">
                    <div className="flex items-center text-xs uppercase text-gray-400 font-medium px-3 mb-2">
                        <div className="w-20">Date</div>
                        <div className="flex-1">Transaction</div>
                        <div className="w-32 text-right">Amount</div>
                        <div className="w-24 text-center">Assets</div>
                        <div className="w-8 text-center">=</div>
                        <div className="w-24 text-center">Liabilities</div>
                        <div className="w-8 text-center">+</div>
                        <div className="w-24 text-center">Equity</div>
                    </div>
                    <div className="space-y-2">
                        {transactions.map((transaction, idx) => {
                            if (transaction.entries.length === 1 && transaction.entries[0].account === 'System') return null;
                            
                            const debits = transaction.entries.filter(e => e.debit > 0).map(e => getAccountDisplay(e.account, parseFloat(e.debit), true));
                            const credits = transaction.entries.filter(e => e.credit > 0).map(e => getAccountDisplay(e.account, parseFloat(e.credit), false));

                            if (transaction.description === 'Initial Balance' && debits.length > 0) {
                                return debits.map((debit, debitIdx) => {
                                    const credit = credits[debitIdx] || credits[0];
                                    const singleAmount = debit.amount;

                                    // Calculate impact using debit/credit effects
                                    const impact = {
                                        assets: 0,
                                        liabilities: 0,
                                        equity: 0
                                    };

                                    // Process debit entry
                                    const debitChange = debit.effect === '↑' ? singleAmount : -singleAmount;
                                    if (debit.category === 'asset') impact.assets += debitChange;
                                    else if (debit.category === 'liability') impact.liabilities += debitChange;
                                    else if (debit.category === 'equity') impact.equity += debitChange;

                                    // Process credit entry
                                    if (credit) {
                                        const creditChange = credit.effect === '↑' ? singleAmount : -singleAmount;
                                        if (credit.category === 'asset') impact.assets += creditChange;
                                        else if (credit.category === 'liability') impact.liabilities += creditChange;
                                        else if (credit.category === 'equity') impact.equity += creditChange;
                                    }
                                    return (
                                        <div key={`${idx}-${debitIdx}`} className="flex items-center bg-gray-700 rounded-lg p-3 hover:bg-gray-650 transition-colors text-sm">
                                            <div className="w-20 text-gray-400">{new Date(transaction.date).toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}</div>
                                            <div className="flex-1">
                                                <p className="font-medium text-white">{transaction.description}</p>
                                                <div className="flex items-center text-xs text-gray-300">
                                                    <span>{credit ? credit.account : 'Equity'}</span>
                                                    <svg className="w-4 h-4 text-gray-500 mx-2 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M17 8l4 4m0 0l-4 4m4-4H3" /></svg>
                                                    <span>{debit.account}</span>
                                                </div>
                                            </div>
                                            <div className="w-32 text-right font-mono text-cyan-400">{singleAmount.toLocaleString('en-US', { style: 'currency', currency: 'USD' })}</div>
                                            <div className="w-24 text-center text-xs font-mono">{renderImpact(impact.assets, 'asset')}</div>
                                            <div className="w-8 text-center text-gray-600">=</div>
                                            <div className="w-24 text-center text-xs font-mono">{renderImpact(impact.liabilities, 'liability')}</div>
                                            <div className="w-8 text-center text-gray-600">+</div>
                                            <div className="w-24 text-center text-xs font-mono">{renderImpact(impact.equity, 'equity')}</div>
                                        </div>
                                    );
                                });
                            }
                            
                            const transactionAmount = debits.reduce((sum, d) => sum + d.amount, 0);
                            const impact = [...debits, ...credits].reduce((acc, item) => {
                                const change = item.effect === '↑' ? item.amount : -item.amount;
                                if (item.category === 'asset') acc.assets += change;
                                else if (item.category === 'liability') acc.liabilities += change;
                                else if (item.category === 'equity' || item.category === 'income') acc.equity += change;
                                if (item.category === 'expense') acc.equity -= item.amount;
                                return acc;
                            }, {assets: 0, liabilities: 0, equity: 0});
                            
                            // Check if this is an expense transaction
                            const expenseEntry = transaction.entries.find(e => e.account === 'Expenses');
                            const isExpense = !!expenseEntry;
                            const categoryInfo = expenseEntry ? { id: expenseEntry.category_id, name: expenseEntry.category_name, color: expenseEntry.category_color } : null;

                            return (
                                <div key={idx} className="bg-gray-700 rounded-lg p-3 hover:bg-gray-650 transition-colors text-sm">
                                    <div className="flex items-center">
                                        <div className="w-20 text-gray-400">{new Date(transaction.date).toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}</div>
                                        <div className="flex-1">
                                            <p className="font-medium text-white">{transaction.description}</p>
                                            <div className="flex items-center text-xs text-gray-300">
                                                <span>{credits.map(c => c.account).join(', ')}</span>
                                                <svg className="w-4 h-4 text-gray-500 mx-2 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M17 8l4 4m0 0l-4 4m4-4H3" /></svg>
                                                <span>{debits.map(d => d.account).join(', ')}</span>
                                            </div>
                                        </div>
                                        <div className="w-32 text-right font-mono text-cyan-400">{transactionAmount.toLocaleString('en-US', { style: 'currency', currency: 'USD' })}</div>
                                        <div className="w-24 text-center text-xs font-mono">{renderImpact(impact.assets, 'asset')}</div>
                                        <div className="w-8 text-center text-gray-600">=</div>
                                        <div className="w-24 text-center text-xs font-mono">{renderImpact(impact.liabilities, 'liability')}</div>
                                        <div className="w-8 text-center text-gray-600">+</div>
                                        <div className="w-24 text-center text-xs font-mono">{renderImpact(impact.equity, 'equity')}</div>
                                    </div>
                                    {isExpense && (
                                        <div className="mt-2 ml-20 flex items-center">
                                            {editingCategory === transaction.uuid ? (
                                                <div className="flex items-center space-x-2">
                                                    <span className="text-xs text-gray-400">Category:</span>
                                                    <select
                                                        value={selectedCategoryId}
                                                        onChange={(e) => setSelectedCategoryId(e.target.value)}
                                                        className="bg-gray-600 text-white text-xs px-2 py-1 rounded"
                                                    >
                                                        {categories && categories.map(cat => (
                                                            <option key={cat.category_id} value={cat.category_id}>{cat.name}</option>
                                                        ))}
                                                    </select>
                                                    <button onClick={() => handleCategoryUpdate(transaction.uuid)} className="text-green-400 hover:text-green-300 text-xs">Save</button>
                                                    <button onClick={() => setEditingCategory(null)} className="text-gray-400 hover:text-gray-300 text-xs">Cancel</button>
                                                </div>
                                            ) : (
                                                <div className="flex items-center space-x-2">
                                                    <span className="text-xs text-gray-400">Category:</span>
                                                    {categoryInfo && categoryInfo.name ? (
                                                        <div className="flex items-center space-x-1">
                                                            <div className="w-3 h-3 rounded" style={{backgroundColor: categoryInfo.color}}></div>
                                                            <span className="text-xs text-gray-300">{categoryInfo.name}</span>
                                                        </div>
                                                    ) : (
                                                        <span className="text-xs text-gray-500">Uncategorized</span>
                                                    )}
                                                    <button
                                                        onClick={() => {
                                                            setEditingCategory(transaction.uuid);
                                                            setSelectedCategoryId(categoryInfo?.id || '');
                                                        }}
                                                        className="text-cyan-400 hover:text-cyan-300 text-xs"
                                                    >
                                                        Edit
                                                    </button>
                                                </div>
                                            )}
                                        </div>
                                    )}
                                </div>
                            );
                        })}
                    </div>
                </div>
            );
        }
        
        function ExpenseAnalysisPage({ showToast }) {
            const [analysisData, setAnalysisData] = useState([]);
            const [isLoading, setIsLoading] = useState(true);
            const [dateRange, setDateRange] = useState('30');
            const [totalExpenses, setTotalExpenses] = useState(0);

            useEffect(() => {
                loadAnalysis();
            }, [dateRange]);

            const loadAnalysis = async () => {
                setIsLoading(true);
                try {
                    const response = await fetchWithCredentials(`${API_BASE_URL}/api/expense_analysis`);
                    if (!response.ok) throw new Error('Failed to fetch analysis data');
                    const data = await response.json();
                    setAnalysisData(data);
                    const total = data.reduce((sum, cat) => sum + parseFloat(cat.total_amount || 0), 0);
                    setTotalExpenses(total);
                } catch (err) {
                    showToast('Error loading expense analysis', 'error');
                } finally {
                    setIsLoading(false);
                }
            };

            const renderPieChart = () => {
                if (!analysisData.length) return null;

                const total = analysisData.reduce((sum, cat) => sum + parseFloat(cat.total_amount), 0);
                let currentAngle = -90; // Start at top

                return (
                    <svg viewBox="0 0 200 200" className="w-full max-w-md mx-auto">
                        {analysisData.map((cat, idx) => {
                            const percentage = (parseFloat(cat.total_amount) / total) * 100;
                            const sliceAngle = (percentage / 100) * 360;
                            const startAngle = currentAngle;
                            const endAngle = currentAngle + sliceAngle;

                            // Convert angles to radians
                            const startRad = (startAngle * Math.PI) / 180;
                            const endRad = (endAngle * Math.PI) / 180;

                            // Calculate coordinates
                            const x1 = 100 + 80 * Math.cos(startRad);
                            const y1 = 100 + 80 * Math.sin(startRad);
                            const x2 = 100 + 80 * Math.cos(endRad);
                            const y2 = 100 + 80 * Math.sin(endRad);

                            const largeArcFlag = sliceAngle > 180 ? 1 : 0;

                            const pathData = [
                                `M 100 100`,
                                `L ${x1} ${y1}`,
                                `A 80 80 0 ${largeArcFlag} 1 ${x2} ${y2}`,
                                `Z`
                            ].join(' ');

                            currentAngle = endAngle;

                            return (
                                <g key={cat.category_id}>
                                    <path
                                        d={pathData}
                                        fill={cat.color || '#6366f1'}
                                        stroke="white"
                                        strokeWidth="1"
                                    />
                                    <title>{cat.name}: ${parseFloat(cat.total_amount).toFixed(2)} ({percentage.toFixed(1)}%)</title>
                                </g>
                            );
                        })}
                        <circle cx="100" cy="100" r="40" fill="#1f2937" />
                        <text x="100" y="95" textAnchor="middle" className="fill-gray-200 text-xs font-semibold">Total</text>
                        <text x="100" y="110" textAnchor="middle" className="fill-cyan-400 text-sm font-bold">${totalExpenses.toFixed(0)}</text>
                    </svg>
                );
            };

            return (
                <div className="space-y-6">
                    <div className="bg-gray-800 shadow rounded-lg p-6">
                        <div className="flex justify-between items-center mb-6">
                            <h2 className="text-xl font-bold text-white">Expense Analysis</h2>
                            <div className="flex items-center space-x-2">
                                <span className="text-gray-400 text-sm">Period:</span>
                                <select value={dateRange} onChange={(e) => setDateRange(e.target.value)} className="bg-gray-700 text-white px-3 py-1 rounded text-sm">
                                    <option value="7">Last 7 days</option>
                                    <option value="30">Last 30 days</option>
                                    <option value="90">Last 90 days</option>
                                </select>
                            </div>
                        </div>

                        {isLoading ? (
                            <div className="text-center py-8">
                                <p className="text-gray-400">Loading analysis...</p>
                            </div>
                        ) : analysisData.length === 0 ? (
                            <div className="text-center py-8">
                                <p className="text-gray-400">No expense data for this period</p>
                            </div>
                        ) : (
                            <div className="grid grid-cols-1 lg:grid-cols-2 gap-8">
                                <div>
                                    <h3 className="text-center text-gray-300 font-medium mb-4">Spending by Category</h3>
                                    {renderPieChart()}
                                </div>

                                <div>
                                    <h3 className="text-gray-300 font-medium mb-4">Category Breakdown</h3>
                                    <div className="space-y-3">
                                        {analysisData.map(cat => {
                                            const percentage = (parseFloat(cat.total_amount) / totalExpenses) * 100;
                                            return (
                                                <div key={cat.category_id} className="bg-gray-700 p-4 rounded-lg">
                                                    <div className="flex items-center justify-between mb-2">
                                                        <div className="flex items-center space-x-3">
                                                            <div className="w-6 h-6 rounded" style={{backgroundColor: cat.color}}></div>
                                                            <span className="text-white font-medium">{cat.name}</span>
                                                        </div>
                                                        <span className="text-cyan-400 font-bold">${parseFloat(cat.total_amount).toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</span>
                                                    </div>
                                                    <div className="flex items-center justify-between text-sm">
                                                        <div className="flex-1 bg-gray-600 rounded-full h-2 mr-3">
                                                            <div
                                                                className="bg-cyan-500 h-2 rounded-full transition-all"
                                                                style={{width: `${percentage}%`}}
                                                            ></div>
                                                        </div>
                                                        <span className="text-gray-400 w-16 text-right">{percentage.toFixed(1)}%</span>
                                                    </div>
                                                    <p className="text-xs text-gray-500 mt-1">{cat.transaction_count} transaction{cat.transaction_count !== 1 ? 's' : ''}</p>
                                                </div>
                                            );
                                        })}
                                    </div>
                                </div>
                            </div>
                        )}
                    </div>
                </div>
            );
        }

        function CategoriesPage({ categories, onDataChange, showToast }) {
            const [isAdding, setIsAdding] = useState(false);
            const [editingId, setEditingId] = useState(null);
            const [newName, setNewName] = useState('');
            const [newColor, setNewColor] = useState('#6366f1');
            const [editingName, setEditingName] = useState('');
            const [editingColor, setEditingColor] = useState('');

            const handleAdd = async () => {
                if (!newName.trim()) {
                    showToast('Please enter a category name', 'error');
                    return;
                }

                try {
                    const response = await fetchWithCredentials(`${API_BASE_URL}/api/expense_categories`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ name: newName, color: newColor })
                    });
                    const result = await response.json();
                    if (result.success) {
                        showToast('Category added successfully', 'success');
                        setNewName('');
                        setNewColor('#6366f1');
                        setIsAdding(false);
                        onDataChange();
                    } else {
                        showToast(result.message, 'error');
                    }
                } catch (err) {
                    showToast('Error adding category', 'error');
                }
            };

            const handleUpdate = async (categoryId) => {
                try {
                    const response = await fetchWithCredentials(`${API_BASE_URL}/api/expense_categories/${categoryId}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ name: editingName, color: editingColor })
                    });
                    const result = await response.json();
                    if (result.success) {
                        showToast('Category updated successfully', 'success');
                        setEditingId(null);
                        onDataChange();
                    } else {
                        showToast(result.message, 'error');
                    }
                } catch (err) {
                    showToast('Error updating category', 'error');
                }
            };

            const handleDelete = async (categoryId, categoryName, isDefault) => {
                if (isDefault) {
                    showToast('Cannot delete the default category', 'error');
                    return;
                }

                if (!confirm(`Delete category "${categoryName}"? All expenses will be moved to Uncategorized.`)) {
                    return;
                }

                try {
                    const response = await fetchWithCredentials(`${API_BASE_URL}/api/expense_categories/${categoryId}`, {
                        method: 'DELETE'
                    });
                    const result = await response.json();
                    if (result.success) {
                        showToast('Category deleted successfully', 'success');
                        onDataChange();
                    } else {
                        showToast(result.message, 'error');
                    }
                } catch (err) {
                    showToast('Error deleting category', 'error');
                }
            };

            return (
                <div className="bg-gray-800 shadow rounded-lg p-6">
                    <div className="flex justify-between items-center mb-6">
                        <h2 className="text-xl font-bold text-white">Expense Categories</h2>
                        <button onClick={() => setIsAdding(!isAdding)} className="bg-cyan-600 hover:bg-cyan-500 text-white font-bold py-2 px-4 rounded">
                            {isAdding ? 'Cancel' : '+ Add Category'}
                        </button>
                    </div>

                    {isAdding && (
                        <div className="bg-gray-700 p-4 rounded-lg mb-6">
                            <h3 className="text-white font-medium mb-3">New Category</h3>
                            <div className="flex items-end space-x-4">
                                <div className="flex-1">
                                    <label className="block text-gray-400 text-sm mb-1">Name</label>
                                    <input type="text" value={newName} onChange={(e) => setNewName(e.target.value)} className="w-full bg-gray-800 text-white p-2 rounded" placeholder="Category name"/>
                                </div>
                                <div>
                                    <label className="block text-gray-400 text-sm mb-1">Color</label>
                                    <input type="color" value={newColor} onChange={(e) => setNewColor(e.target.value)} className="bg-gray-800 p-1 rounded h-10 w-20"/>
                                </div>
                                <button onClick={handleAdd} className="bg-green-600 hover:bg-green-500 text-white px-4 py-2 rounded">Add</button>
                            </div>
                        </div>
                    )}

                    <div className="space-y-2">
                        {categories.map(cat => (
                            <div key={cat.category_id} className="flex items-center justify-between bg-gray-700 p-4 rounded-lg">
                                {editingId === cat.category_id ? (
                                    <>
                                        <div className="flex items-center space-x-4 flex-1">
                                            <input type="color" value={editingColor} onChange={(e) => setEditingColor(e.target.value)} className="bg-gray-800 p-1 rounded h-10 w-20"/>
                                            <input type="text" value={editingName} onChange={(e) => setEditingName(e.target.value)} className="flex-1 bg-gray-800 text-white p-2 rounded"/>
                                        </div>
                                        <div className="flex space-x-2 ml-4">
                                            <button onClick={() => handleUpdate(cat.category_id)} className="text-green-400 hover:text-green-300 text-sm font-semibold">Save</button>
                                            <button onClick={() => setEditingId(null)} className="text-gray-400 hover:text-gray-300 text-sm font-semibold">Cancel</button>
                                        </div>
                                    </>
                                ) : (
                                    <>
                                        <div className="flex items-center space-x-4">
                                            <div className="w-8 h-8 rounded" style={{backgroundColor: cat.color}}></div>
                                            <span className="text-white font-medium">{cat.name}</span>
                                            {!!cat.is_default && <span className="text-xs text-gray-400 bg-gray-600 px-2 py-1 rounded">Default</span>}
                                        </div>
                                        <div className="flex space-x-3">
                                            <button onClick={() => { setEditingId(cat.category_id); setEditingName(cat.name); setEditingColor(cat.color); }} className="text-cyan-400 hover:text-cyan-300 text-sm">Edit</button>
                                            {!cat.is_default && (
                                                <button onClick={() => handleDelete(cat.category_id, cat.name, cat.is_default)} className="text-red-400 hover:text-red-300 text-sm">Delete</button>
                                            )}
                                        </div>
                                    </>
                                )}
                            </div>
                        ))}
                    </div>
                </div>
            );
        }

        function RecurringExpensesPage({ accounts, onDataChange }) {
            const [expenses, setExpenses] = useState([]);
            const [isLoading, setIsLoading] = useState(true);
            const [error, setError] = useState('');
            
            const [newDescription, setNewDescription] = useState('');
            const [newAmount, setNewAmount] = useState('');
            const [newPaymentAccountId, setNewPaymentAccountId] = useState('');
            const [newDueDay, setNewDueDay] = useState('1');

            const [editingId, setEditingId] = useState(null);
            const [editingDescription, setEditingDescription] = useState('');
            const [editingAmount, setEditingAmount] = useState('');
            const [editingDueDay, setEditingDueDay] = useState('');

            useEffect(() => {
                let mounted = true;
                const loadExpenses = async () => {
                    setIsLoading(true);
                    try {
                        const response = await fetchWithCredentials(`${API_BASE_URL}/api/recurring_expenses`);
                        if (!response.ok) throw new Error('Failed to fetch recurring expenses.');
                        const data = await response.json();
                        if (mounted) setExpenses(data);
                    } catch (err) {
                        if (mounted) setError(err.message);
                    } finally {
                        if (mounted) setIsLoading(false);
                    }
                };
                loadExpenses();
                return () => { mounted = false; };
            }, []);

            const handleDelete = async (expenseId) => {
                if (confirm('Are you sure you want to delete this recurring expense?')) {
                    try {
                        const response = await fetchWithCredentials(`${API_BASE_URL}/api/recurring_expenses/${expenseId}`, { method: 'DELETE' });
                        if (response.ok) onDataChange(); 
                        else {
                            const result = await response.json();
                            setError(result.message || 'Failed to delete expense.');
                        }
                    } catch (err) { setError('An error occurred. Please try again.'); }
                }
            };

            const handleAddNewExpense = async (e) => {
                e.preventDefault();
                setError('');
                if (!newDescription || !newAmount || !newPaymentAccountId || !newDueDay) {
                    setError('All fields are required for new expense.');
                    return;
                }
                try {
                    const response = await fetchWithCredentials(`${API_BASE_URL}/api/recurring_expenses`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ 
                            description: newDescription, 
                            amount: parseFloat(newAmount), 
                            payment_account_id: parseInt(newPaymentAccountId),
                            due_day_of_month: parseInt(newDueDay)
                        }),
                    });
                    const result = await response.json();
                    if (response.ok) {
                        setNewDescription('');
                        setNewAmount('');
                        setNewPaymentAccountId('');
                        setNewDueDay('1');
                        onDataChange();
                    } else { setError(result.message); }
                } catch (err) { setError('An error occurred. Please try again.'); }
            };

            const handleEditClick = (expense) => {
                setEditingId(expense.expense_id);
                setEditingDescription(expense.description);
                setEditingAmount(expense.amount);
                setEditingDueDay(expense.due_day_of_month);
            };

            const handleCancelEdit = () => setEditingId(null);

            const handleUpdateExpense = async (expenseId) => {
                try {
                    const response = await fetchWithCredentials(`${API_BASE_URL}/api/recurring_expenses/${expenseId}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ 
                            description: editingDescription, 
                            amount: parseFloat(editingAmount),
                            due_day_of_month: parseInt(editingDueDay)
                        })
                    });
                    if (response.ok) {
                        handleCancelEdit();
                        onDataChange();
                    } else {
                        const result = await response.json();
                        setError(result.message || 'Failed to update expense.');
                    }
                } catch(err) { setError('An error occurred during update. Please try again.'); }
            };

            return (
                <div className="grid grid-cols-1 md:grid-cols-3 gap-6 mt-6">
                    <div className="md:col-span-2 bg-gray-800 shadow rounded-lg p-4">
                        <h2 className="text-xl font-bold text-white mb-4">Manage Recurring Expenses</h2>
                        {isLoading ? <p>Loading...</p> :
                            <>
                                <table className="w-full divide-y divide-gray-700">
                                    <thead className="bg-gray-700">
                                        <tr>
                                            <th className="px-4 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider whitespace-nowrap">Description</th>
                                            <th className="px-4 py-3 text-right text-xs font-medium text-gray-300 uppercase tracking-wider whitespace-nowrap">Amount</th>
                                            <th className="px-4 py-3 text-center text-xs font-medium text-gray-300 uppercase tracking-wider whitespace-nowrap">Due Day</th>
                                            <th className="px-4 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider whitespace-nowrap">Payment Account</th>
                                            <th className="px-4 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider whitespace-nowrap">Last Paid</th>
                                            <th className="px-4 py-3 text-right text-xs font-medium text-gray-300 uppercase tracking-wider whitespace-nowrap">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody className="bg-gray-800 divide-y divide-gray-700">
                                        {expenses.map(exp => (
                                            <tr key={exp.expense_id}>
                                                {editingId === exp.expense_id ? (
                                                    <>
                                                        <td className="px-2 py-2"><input type="text" value={editingDescription} onChange={e => setEditingDescription(e.target.value)} className="bg-gray-700 text-white p-1 rounded w-full"/></td>
                                                        <td className="px-2 py-2"><input type="number" step="0.01" value={editingAmount} onChange={e => setEditingAmount(e.target.value)} className="bg-gray-700 text-white p-1 rounded w-24 text-right"/></td>
                                                        <td className="px-2 py-2"><input type="number" value={editingDueDay} onChange={e => setEditingDueDay(e.target.value)} className="bg-gray-700 text-white p-1 rounded w-16 text-center"/></td>
                                                        <td className="px-2 py-2 text-sm text-gray-500">{exp.payment_account_name}</td>
                                                        <td className="px-2 py-2"></td>
                                                        <td className="px-2 py-2 text-sm text-right space-x-2">
                                                            <button onClick={() => handleUpdateExpense(exp.expense_id)} className="text-green-500 hover:text-green-400 text-xs font-semibold">Save</button>
                                                            <button onClick={handleCancelEdit} className="text-gray-400 hover:text-gray-300 text-xs font-semibold">Cancel</button>
                                                        </td>
                                                    </>
                                                ) : (
                                                    <>
                                                        <td className="px-4 py-4 whitespace-nowrap text-sm text-white">{exp.description}</td>
                                                        <td className="px-4 py-4 whitespace-nowrap text-sm text-right font-mono text-red-400">{parseFloat(exp.amount).toLocaleString('en-US', { style: 'currency', currency: 'USD' })}</td>
                                                        <td className="px-4 py-4 whitespace-nowrap text-sm text-center">{exp.due_day_of_month}</td>
                                                        <td className="px-4 py-4 whitespace-nowrap text-sm text-gray-400">{exp.payment_account_name}</td>
                                                        <td className="px-4 py-4 whitespace-nowrap text-sm text-gray-400">{exp.last_processed_date ? new Date(exp.last_processed_date).toLocaleDateString('en-CA') : 'Never'}</td>
                                                        <td className="px-4 py-4 whitespace-nowrap text-sm text-right space-x-2">
                                                            <button onClick={() => handleEditClick(exp)} className="text-cyan-400 hover:text-cyan-300 text-xs font-semibold">Edit</button>
                                                            <button onClick={() => handleDelete(exp.expense_id)} className="text-red-500 hover:text-red-400 text-xs font-semibold">Delete</button>
                                                        </td>
                                                    </>
                                                )}
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                            </>
                        }
                         {expenses.length === 0 && !isLoading && <p className="text-gray-500 py-4 text-center">You have no recurring expenses set up.</p>}
                    </div>
                    <div className="bg-gray-800 shadow rounded-lg p-6">
                        <h2 className="text-xl font-bold text-white mb-4">Add New Bill</h2>
                        <form onSubmit={handleAddNewExpense}>
                            <div className="mb-4">
                                <label className="block text-gray-400 mb-2">Description</label>
                                <input type="text" value={newDescription} onChange={(e) => setNewDescription(e.target.value)} className="w-full bg-gray-700 text-white p-2 rounded" placeholder="e.g., Netflix"/>
                            </div>
                            <div className="grid grid-cols-2 gap-4 mb-4">
                                <div>
                                    <label className="block text-gray-400 mb-2">Amount</label>
                                    <input type="number" step="0.01" value={newAmount} onChange={(e) => setNewAmount(e.target.value)} className="w-full bg-gray-700 text-white p-2 rounded" placeholder="15.99"/>
                                </div>
                                <div>
                                    <label className="block text-gray-400 mb-2">Due Day</label>
                                    <input type="number" min="1" max="31" value={newDueDay} onChange={(e) => setNewDueDay(e.target.value)} className="w-full bg-gray-700 text-white p-2 rounded" />
                                </div>
                            </div>
                            <div className="mb-6">
                                <label className="block text-gray-400 mb-2">Pay From Account</label>
                                <select value={newPaymentAccountId} onChange={(e) => setNewPaymentAccountId(e.target.value)} className="w-full bg-gray-700 text-white p-2 rounded">
                                    <option value="">-- Select an Account --</option>
                                    {accounts.filter(acc => acc.type !== 'CASH').map(acc => <option key={acc.account_id} value={acc.account_id}>{acc.name}</option>)}
                                </select>
                            </div>
                             {error && <p className="text-red-400 mb-4 text-center">{error}</p>}
                            <button type="submit" className="w-full bg-cyan-600 hover:bg-cyan-500 text-white font-bold py-2 px-4 rounded">
                                + Add Recurring Expense
                            </button>
                        </form>
                    </div>
                </div>
            );
        }

        function LogIncomeForm({ accounts, onClose, onIncomeAdded, suggestions, showToast }) {
            const [description, setDescription] = useState('');
            const [amount, setAmount] = useState('');
            const [selectedAccountId, setSelectedAccountId] = useState('');
            const [transactionDate, setTransactionDate] = useState('');
            const [error, setError] = useState('');

            const handleSubmit = async (event) => {
                event.preventDefault();
                setError('');

                // Frontend validation
                if (!description.trim()) { setError('Please enter a description.'); return; }
                if (!amount || parseFloat(amount) <= 0) { setError('Please enter a valid positive amount.'); return; }
                if (!selectedAccountId) { setError('Please select an account.'); return; }

                try {
                    const payload = {
                        description,
                        amount: parseFloat(amount),
                        account_id: parseInt(selectedAccountId)
                    };

                    // Add optional transaction date if provided
                    if (transactionDate) {
                        payload.transaction_date = transactionDate;
                    }

                    const response = await fetchWithCredentials(`${API_BASE_URL}/api/income`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload),
                    });
                    const result = await response.json();
                    if (result.success) {
                        showToast('Income added successfully', 'success');
                        onIncomeAdded();
                        onClose();
                    } else {
                        setError(result.message);
                        showToast(result.message, 'error');
                    }
                } catch (err) {
                    setError('An error occurred. Please try again.');
                    showToast('An error occurred. Please try again.', 'error');
                }
            };
            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center">
                    <div className="bg-gray-800 p-6 rounded-lg shadow-xl w-full max-w-md">
                        <h2 className="text-2xl font-bold mb-4 text-white">Log New Income</h2>
                        <form onSubmit={handleSubmit}>
                            <div className="mb-4">
                                <label className="block text-gray-400 mb-2">Account</label>
                                <select value={selectedAccountId} onChange={(e) => setSelectedAccountId(e.target.value)} className="w-full bg-gray-700 text-white p-2 rounded">
                                    <option value="">-- Select an Account --</option>
                                    {accounts.map(acc => <option key={acc.account_id} value={acc.account_id}>{acc.name}</option>)}
                                </select>
                            </div>
                            <div className="mb-4">
                                <label className="block text-gray-400 mb-2">Description</label>
                                <input type="text" value={description} onChange={(e) => setDescription(e.target.value)} className="w-full bg-gray-700 text-white p-2 rounded" list="income-suggestions" required/>
                                <datalist id="income-suggestions">{suggestions.map(s => <option key={s} value={s} />)}</datalist>
                            </div>
                            <div className="grid grid-cols-2 gap-4 mb-4">
                                <div>
                                    <label className="block text-gray-400 mb-2">Amount</label>
                                    <input type="number" step="0.01" min="0.01" value={amount} onChange={(e) => setAmount(e.target.value)} className="w-full bg-gray-700 text-white p-2 rounded" required/>
                                </div>
                                <div>
                                    <label className="block text-gray-400 mb-2">Date (Optional)</label>
                                    <input type="date" value={transactionDate} onChange={(e) => setTransactionDate(e.target.value)} className="w-full bg-gray-700 text-white p-2 rounded"/>
                                </div>
                            </div>
                            {error && <p className="text-red-400 mb-4">{error}</p>}
                            <div className="flex justify-end space-x-4">
                                <button type="button" onClick={onClose} className="bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded">Cancel</button>
                                <button type="submit" className="bg-cyan-600 hover:bg-cyan-500 text-white font-bold py-2 px-4 rounded">Log Income</button>
                            </div>
                        </form>
                    </div>
                </div>
            );
        }

        function TransferForm({ accounts, onClose, onTransferComplete, showToast }) {
            const [fromAccountId, setFromAccountId] = useState('');
            const [toAccountId, setToAccountId] = useState('');
            const [amount, setAmount] = useState('');
            const [description, setDescription] = useState('Account Transfer');
            const [transactionDate, setTransactionDate] = useState('');
            const [error, setError] = useState('');

            const handleSubmit = async (event) => {
                event.preventDefault();
                setError('');

                // Frontend validation
                if (!fromAccountId) { setError('Please select a source account.'); return; }
                if (!toAccountId) { setError('Please select a destination account.'); return; }
                if (fromAccountId === toAccountId) { setError('Cannot transfer to the same account.'); return; }
                if (!amount || parseFloat(amount) <= 0) { setError('Please enter a valid positive amount.'); return; }

                try {
                    const payload = {
                        from_account_id: parseInt(fromAccountId),
                        to_account_id: parseInt(toAccountId),
                        amount: parseFloat(amount),
                        description
                    };

                    if (transactionDate) {
                        payload.transaction_date = transactionDate;
                    }

                    const response = await fetchWithCredentials(`${API_BASE_URL}/api/transfer`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload),
                    });
                    const result = await response.json();
                    if (result.success) {
                        showToast('Transfer completed successfully', 'success');
                        onTransferComplete();
                        onClose();
                    } else {
                        setError(result.message);
                        showToast(result.message, 'error');
                    }
                } catch (err) {
                    setError('An error occurred. Please try again.');
                    showToast('An error occurred. Please try again.', 'error');
                }
            };

            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center">
                    <div className="bg-gray-800 p-6 rounded-lg shadow-xl w-full max-w-md">
                        <h2 className="text-2xl font-bold mb-4 text-white">Transfer Between Accounts</h2>
                        <form onSubmit={handleSubmit}>
                            <div className="mb-4">
                                <label className="block text-gray-400 mb-2">From Account</label>
                                <select value={fromAccountId} onChange={(e) => setFromAccountId(e.target.value)} className="w-full bg-gray-700 text-white p-2 rounded">
                                    <option value="">-- Select Source Account --</option>
                                    {accounts.map(acc => (
                                        <option key={acc.account_id} value={acc.account_id}>
                                            {acc.name} (${parseFloat(acc.balance).toFixed(2)})
                                        </option>
                                    ))}
                                </select>
                            </div>
                            <div className="mb-4">
                                <label className="block text-gray-400 mb-2">To Account</label>
                                <select value={toAccountId} onChange={(e) => setToAccountId(e.target.value)} className="w-full bg-gray-700 text-white p-2 rounded">
                                    <option value="">-- Select Destination Account --</option>
                                    {accounts.map(acc => (
                                        <option key={acc.account_id} value={acc.account_id}>
                                            {acc.name} (${parseFloat(acc.balance).toFixed(2)})
                                        </option>
                                    ))}
                                </select>
                            </div>
                            <div className="mb-4">
                                <label className="block text-gray-400 mb-2">Description (Optional)</label>
                                <input type="text" value={description} onChange={(e) => setDescription(e.target.value)} className="w-full bg-gray-700 text-white p-2 rounded"/>
                            </div>
                            <div className="grid grid-cols-2 gap-4 mb-4">
                                <div>
                                    <label className="block text-gray-400 mb-2">Amount</label>
                                    <input type="number" step="0.01" min="0.01" value={amount} onChange={(e) => setAmount(e.target.value)} className="w-full bg-gray-700 text-white p-2 rounded" required/>
                                </div>
                                <div>
                                    <label className="block text-gray-400 mb-2">Date (Optional)</label>
                                    <input type="date" value={transactionDate} onChange={(e) => setTransactionDate(e.target.value)} className="w-full bg-gray-700 text-white p-2 rounded"/>
                                </div>
                            </div>
                            {error && <p className="text-red-400 mb-4">{error}</p>}
                            <div className="flex justify-end space-x-4">
                                <button type="button" onClick={onClose} className="bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded">Cancel</button>
                                <button type="submit" className="bg-indigo-600 hover:bg-indigo-500 text-white font-bold py-2 px-4 rounded">Transfer</button>
                            </div>
                        </form>
                    </div>
                </div>
            );
        }

        function LogExpenseForm({ accounts, onClose, onExpenseAdded, suggestions, showToast, categories }) {
            const [description, setDescription] = useState('');
            const [amount, setAmount] = useState('');
            const [selectedAccountId, setSelectedAccountId] = useState('');
            const [selectedCategoryId, setSelectedCategoryId] = useState('');
            const [transactionDate, setTransactionDate] = useState('');
            const [error, setError] = useState('');

            const handleSubmit = async (event) => {
                event.preventDefault();
                setError('');

                // Frontend validation
                if (!description.trim()) { setError('Please enter a description.'); return; }
                if (!amount || parseFloat(amount) <= 0) { setError('Please enter a valid positive amount.'); return; }
                if (!selectedAccountId) { setError('Please select an account.'); return; }

                try {
                    const payload = {
                        description,
                        amount: parseFloat(amount),
                        account_id: parseInt(selectedAccountId)
                    };

                    // Add optional fields if provided
                    if (selectedCategoryId) {
                        payload.category_id = parseInt(selectedCategoryId);
                    }
                    if (transactionDate) {
                        payload.transaction_date = transactionDate;
                    }

                    const response = await fetchWithCredentials(`${API_BASE_URL}/api/expense`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload),
                    });
                    const result = await response.json();
                    if (result.success) {
                        showToast('Expense added successfully', 'success');
                        onExpenseAdded();
                        onClose();
                    } else {
                        setError(result.message);
                        showToast(result.message, 'error');
                    }
                } catch (err) {
                    setError('An error occurred. Please try again.');
                    showToast('An error occurred. Please try again.', 'error');
                }
            };
            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center">
                    <div className="bg-gray-800 p-6 rounded-lg shadow-xl w-full max-w-md">
                        <h2 className="text-2xl font-bold mb-4 text-white">Log New Expense</h2>
                        <form onSubmit={handleSubmit}>
                            <div className="mb-4">
                                <label className="block text-gray-400 mb-2">Pay From Account</label>
                                <select value={selectedAccountId} onChange={(e) => setSelectedAccountId(e.target.value)} className="w-full bg-gray-700 text-white p-2 rounded">
                                    <option value="">-- Select an Account --</option>
                                    {accounts.map(acc => <option key={acc.account_id} value={acc.account_id}>{acc.name}</option>)}
                                </select>
                            </div>
                            <div className="mb-4">
                                <label className="block text-gray-400 mb-2">Category (defaults to Uncategorized)</label>
                                <select value={selectedCategoryId} onChange={(e) => setSelectedCategoryId(e.target.value)} className="w-full bg-gray-700 text-white p-2 rounded">
                                    <option value="">-- Select Category (Optional) --</option>
                                    {categories && categories.filter(cat => !cat.is_default).map(cat => (
                                        <option key={cat.category_id} value={cat.category_id}>
                                            {cat.name}
                                        </option>
                                    ))}
                                </select>
                            </div>
                            <div className="mb-4">
                                <label className="block text-gray-400 mb-2">Description</label>
                                <input type="text" value={description} onChange={(e) => setDescription(e.target.value)} className="w-full bg-gray-700 text-white p-2 rounded" list="expense-suggestions" required/>
                                <datalist id="expense-suggestions">{suggestions.map(s => <option key={s} value={s} />)}</datalist>
                            </div>
                            <div className="grid grid-cols-2 gap-4 mb-4">
                                <div>
                                    <label className="block text-gray-400 mb-2">Amount</label>
                                    <input type="number" step="0.01" min="0.01" value={amount} onChange={(e) => setAmount(e.target.value)} className="w-full bg-gray-700 text-white p-2 rounded" required/>
                                </div>
                                <div>
                                    <label className="block text-gray-400 mb-2">Date (Optional)</label>
                                    <input type="date" value={transactionDate} onChange={(e) => setTransactionDate(e.target.value)} className="w-full bg-gray-700 text-white p-2 rounded"/>
                                </div>
                            </div>
                            {error && <p className="text-red-400 mb-4">{error}</p>}
                            <div className="flex justify-end space-x-4">
                                <button type="button" onClick={onClose} className="bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded">Cancel</button>
                                <button type="submit" className="bg-red-600 hover:bg-red-500 text-white font-bold py-2 px-4 rounded">Log Expense</button>
                            </div>
                        </form>
                    </div>
                </div>
            );
        }

        // --- MAIN APP COMPONENT ---
        function App() {
            const [isLoading, setIsLoading] = useState(true);
            const [username, setUsername] = useState('');
            const [accounts, setAccounts] = useState([]);
            const [ledger, setLedger] = useState([]);
            const [error, setError] = useState(null);
            const [activePage, setActivePage] = useState('accounts');
            const [isIncomeFormVisible, setIsIncomeFormVisible] = useState(false);
            const [isExpenseFormVisible, setIsExpenseFormVisible] = useState(false);
            const [isTransferFormVisible, setIsTransferFormVisible] = useState(false);
            const [incomeDescriptions, setIncomeDescriptions] = useState([]);
            const [expenseDescriptions, setExpenseDescriptions] = useState([]);
            const [expenseCategories, setExpenseCategories] = useState([]);
            const [meterData, setMeterData] = useState(null);
            const [averageData, setAverageData] = useState(null);
            const [status, setStatus] = useState(null);
            const [toast, setToast] = useState(null);

            const showToast = (message, type = 'info') => {
                setToast({ message, type });
            };

            const refreshData = async () => {
                try {
                    !isLoading && setIsLoading(true);
                    const responses = await Promise.all([
                        fetchWithCredentials(`${API_BASE_URL}/api/accounts`),
                        fetchWithCredentials(`${API_BASE_URL}/api/ledger`),
                        fetchWithCredentials(`${API_BASE_URL}/api/descriptions/income`),
                        fetchWithCredentials(`${API_BASE_URL}/api/descriptions/expense`),
                        fetchWithCredentials(`${API_BASE_URL}/api/expense_categories`),
                        fetchWithCredentials(`${API_BASE_URL}/api/meter/summary`),
                        fetchWithCredentials(`${API_BASE_URL}/api/meter/n_day_average?days=30`),
                        fetchWithCredentials(`${API_BASE_URL}/api/status`)
                    ]);
                    if (responses.some(res => !res.ok)) {
                        const failedIndex = responses.findIndex(r => !r.ok);
                        const endpoints = ['accounts', 'ledger', 'income descriptions', 'expense descriptions', 'expense categories', 'meter summary', 'n-day average', 'status'];
                        console.error(`Failed to fetch ${endpoints[failedIndex]}:`, responses[failedIndex].status);
                        window.location.href = 'login.html';
                        return;
                    }
                    const [accountsData, ledgerData, incomeDescData, expenseDescData, categoriesData, meterSummaryData, averageDataResponse, statusData] = await Promise.all(responses.map(res => res.json()));
                    setAccounts(accountsData);
                    setLedger(ledgerData);
                    setIncomeDescriptions(incomeDescData);
                    setExpenseDescriptions(expenseDescData);
                    setExpenseCategories(categoriesData);
                    setMeterData(meterSummaryData);
                    setAverageData(averageDataResponse);
                    setStatus(statusData);
                } catch (error) {
                    setError(error.message);
                } finally {
                    setIsLoading(false);
                }
            };

            const handleTransactionAdded = () => { refreshData(); };

            useEffect(() => {
                const checkSession = async () => {
                    try {
                        const response = await fetchWithCredentials(`${API_BASE_URL}/api/check_session`);
                        if (response.ok) {
                            const data = await response.json();
                            setUsername(data.username);
                            refreshData();
                        } else {
                           window.location.href = 'login.html';
                        }
                    } catch (error) {
                        console.error("API server is not responding.", error);
                        window.location.href = 'login.html';
                    }
                };
                checkSession();
            }, []);

            if (error) { return <div className="text-red-400 p-8">Error: {error}</div>; }

            const navButtonClasses = (page) =>
                `px-4 py-2 text-sm font-medium rounded-md ${activePage === page ? 'bg-cyan-600 text-white' : 'bg-gray-700 text-gray-300 hover:bg-gray-600'}`;

            return (
                <div className="container mx-auto p-4 max-w-7xl">
                    {status && <Header status={status} onTimeAdvanced={refreshData} username={username} showToast={showToast} />}
                    <main>
                        {isLoading ? ( <LoadingSpinner text="Loading your financial data..." /> ) : (
                            <div>
                                {meterData && <Meter meterData={meterData} averageData={averageData} />}
                                <BalanceSheetSummary accounts={accounts} />
                                <div className="flex space-x-4 mb-6">
                                    <button onClick={() => setActivePage('accounts')} className={navButtonClasses('accounts')}>Accounts</button>
                                    <button onClick={() => setActivePage('ledger')} className={navButtonClasses('ledger')}>Ledger</button>
                                    <button onClick={() => setActivePage('recurring')} className={navButtonClasses('recurring')}>Recurring</button>
                                    <button onClick={() => setActivePage('categories')} className={navButtonClasses('categories')}>Categories</button>
                                    <button onClick={() => setActivePage('analysis')} className={navButtonClasses('analysis')}>Analysis</button>
                                    <div className="ml-auto flex space-x-2">
                                        <button onClick={() => setIsTransferFormVisible(true)} className="bg-indigo-600 hover:bg-indigo-500 text-white font-bold py-2 px-4 rounded-md">⇄ Transfer</button>
                                        <button onClick={() => setIsIncomeFormVisible(true)} className="bg-green-600 hover:bg-green-500 text-white font-bold py-2 px-4 rounded-md">+ Add Income</button>
                                        <button onClick={() => setIsExpenseFormVisible(true)} className="bg-red-600 hover:bg-red-500 text-white font-bold py-2 px-4 rounded-md">- Add Expense</button>
                                    </div>
                                </div>
                                {activePage === 'accounts' && <AccountsList accounts={accounts} onDataChange={refreshData} showToast={showToast} />}
                                {activePage === 'ledger' && <LedgerView ledger={ledger} accounts={accounts} categories={expenseCategories} onDataChange={refreshData} showToast={showToast} />}
                                {activePage === 'recurring' && <RecurringExpensesPage accounts={accounts} onDataChange={refreshData} />}
                                {activePage === 'categories' && <CategoriesPage categories={expenseCategories} onDataChange={refreshData} showToast={showToast} />}
                                {activePage === 'analysis' && <ExpenseAnalysisPage showToast={showToast} />}
                            </div>
                        )}
                    </main>
                    {isTransferFormVisible && <TransferForm accounts={accounts.filter(acc => !['EQUITY'].includes(acc.type))} onClose={() => setIsTransferFormVisible(false)} onTransferComplete={handleTransactionAdded} showToast={showToast}/>}
                    {isIncomeFormVisible && <LogIncomeForm accounts={accounts.filter(acc => ['CHECKING', 'SAVINGS', 'CASH'].includes(acc.type))} onClose={() => setIsIncomeFormVisible(false)} onIncomeAdded={handleTransactionAdded} suggestions={incomeDescriptions} showToast={showToast}/>}
                    {isExpenseFormVisible && <LogExpenseForm accounts={accounts.filter(acc => !['FIXED_ASSET', 'LOAN', 'EQUITY'].includes(acc.type))} onClose={() => setIsExpenseFormVisible(false)} onExpenseAdded={handleTransactionAdded} suggestions={expenseDescriptions} showToast={showToast} categories={expenseCategories}/>}
                    {toast && <Toast message={toast.message} type={toast.type} onClose={() => setToast(null)} />}
                </div>
            );
        }

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>