<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Register - Perfect Books</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@17/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@17/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="themes.js"></script>
    <style>
        :root {
            --color-bg: #111827;
            --color-bg-secondary: #1f2937;
            --color-bg-tertiary: #374151;
            --color-bg-hover: #4b5563;
            --color-text: #f9fafb;
            --color-text-secondary: #d1d5db;
            --color-text-muted: #9ca3af;
            --color-border: #4b5563;
            --color-border-light: #374151;
            --color-primary: #06b6d4;
            --color-primary-hover: #0891b2;
            --color-primary-light: #22d3ee;
            --color-success: #10b981;
            --color-success-light: #34d399;
            --color-danger: #ef4444;
            --color-danger-light: #f87171;
            --color-warning: #f59e0b;
            --color-warning-light: #fbbf24;
        }
    </style>
</head>
<body style="background-color: var(--color-bg); color: var(--color-text);">
    <div id="root"></div>

    <script type="text/babel">
        const { useState } = React;
        const API_BASE_URL = '';

        // Theme management functions
        const applyTheme = (themeName) => {
            const theme = THEMES[themeName] || THEMES[DEFAULT_THEME];
            const root = document.documentElement;
            Object.entries(theme.colors).forEach(([key, value]) => {
                const cssVarName = `--color-${key.replace(/([A-Z])/g, '-$1').toLowerCase()}`;
                root.style.setProperty(cssVarName, value);
            });
            localStorage.setItem('theme', themeName);
        };

        const loadSavedTheme = () => {
            const savedTheme = localStorage.getItem('theme') || DEFAULT_THEME;
            applyTheme(savedTheme);
            return savedTheme;
        };

        // Initialize theme immediately
        loadSavedTheme();

        function RegistrationForm() {
            const [username, setUsername] = useState('');
            const [password, setPassword] = useState('');
            const [error, setError] = useState(null);
            const [isSubmitting, setIsSubmitting] = useState(false);
            const [showPassword, setShowPassword] = useState(false);
            const [currentTheme, setCurrentTheme] = useState(() => {
                return localStorage.getItem('theme') || DEFAULT_THEME;
            });

            const handleThemeChange = (e) => {
                const newTheme = e.target.value;
                setCurrentTheme(newTheme);
                applyTheme(newTheme);
            };

            const handleSubmit = async (event) => {
                event.preventDefault();
                setError(null);
                setIsSubmitting(true);

                if (password.length < 8) {
                    setError("Password must be at least 8 characters long.");
                    setIsSubmitting(false);
                    return;
                }

                try {
                    const response = await fetch(`${API_BASE_URL}/api/register`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        credentials: 'include',
                        body: JSON.stringify({ username, password }),
                    });

                    const result = await response.json();

                    if (response.ok) {
                        // Registration was successful, user is now logged in.
                        // The API response tells us if setup is needed.
                        if (result.setup_needed) {
                            window.location.href = 'setup.html';
                        } else {
                            window.location.href = 'index.html';
                        }
                    } else {
                        setError(result.message);
                    }
                } catch (err) {
                    setError("An error occurred. Is the API server running?");
                } finally {
                    setIsSubmitting(false);
                }
            };

            return (
                <div className="min-h-screen flex items-center justify-center">
                    <div className="p-8 rounded-lg shadow-xl w-full max-w-sm" style={{backgroundColor: 'var(--color-bg-secondary)'}}>
                        <div className="flex justify-between items-center mb-6">
                            <h1 className="text-3xl font-bold" style={{color: 'var(--color-text)'}}>Create Account</h1>
                            <select
                                value={currentTheme}
                                onChange={handleThemeChange}
                                style={{
                                    backgroundColor: 'var(--color-bg-tertiary)',
                                    color: 'var(--color-text)',
                                    borderColor: 'var(--color-border)'
                                }}
                                className="px-2 py-1 rounded text-xs focus:outline-none focus:ring-2"
                                title="Change theme"
                            >
                                {Object.keys(THEMES).map(themeKey => (
                                    <option key={themeKey} value={themeKey}>
                                        {THEMES[themeKey].name}
                                    </option>
                                ))}
                            </select>
                        </div>

                        <form onSubmit={handleSubmit}>
                            <div className="mb-4">
                                <label className="block mb-2" style={{color: 'var(--color-text-secondary)'}}>Username</label>
                                <input
                                    type="text"
                                    value={username}
                                    onChange={(e) => setUsername(e.target.value)}
                                    className="w-full p-2 rounded"
                                    style={{backgroundColor: 'var(--color-bg-tertiary)', color: 'var(--color-text)', borderColor: 'var(--color-border)'}}
                                    required
                                />
                            </div>
                            <div className="mb-6">
                                <label className="block mb-2" style={{color: 'var(--color-text-secondary)'}}>Password</label>
                                <div className="relative">
                                    <input
                                        type={showPassword ? "text" : "password"}
                                        value={password}
                                        onChange={(e) => setPassword(e.target.value)}
                                        className="w-full p-2 pr-16 rounded"
                                        style={{backgroundColor: 'var(--color-bg-tertiary)', color: 'var(--color-text)', borderColor: 'var(--color-border)'}}
                                        required
                                    />
                                    <button
                                        type="button"
                                        onMouseDown={() => setShowPassword(true)}
                                        onMouseUp={() => setShowPassword(false)}
                                        onMouseLeave={() => setShowPassword(false)}
                                        onTouchStart={() => setShowPassword(true)}
                                        onTouchEnd={() => setShowPassword(false)}
                                        className="absolute right-2 top-1/2 transform -translate-y-1/2 text-xs px-2 py-1 rounded select-none"
                                        style={{color: 'var(--color-text-muted)'}}
                                    >
                                        (show)
                                    </button>
                                </div>
                            </div>

                            {error && <p className="mb-4 text-center" style={{color: 'var(--color-danger)'}}>{error}</p>}

                            <button type="submit" className="w-full font-bold py-2 px-4 rounded" style={{backgroundColor: 'var(--color-primary)', color: 'var(--color-text)'}} disabled={isSubmitting}>
                                {isSubmitting ? 'Registering...' : 'Register'}
                            </button>
                        </form>
                        <p className="text-center text-sm mt-6" style={{color: 'var(--color-text-muted)'}}>
                            Already have an account? <a href="login.html" className="hover:underline" style={{color: 'var(--color-primary)'}}>Log in here</a>.
                        </p>
                    </div>
                </div>
            );
        }

        ReactDOM.render(<RegistrationForm />, document.getElementById('root'));
    </script>
</body>
</html>