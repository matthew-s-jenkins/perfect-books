<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manage Accounts - Perfect Books</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@17/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@17/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="themes.js"></script>
    <style>
        :root {
            --color-bg: #111827;
            --color-bg-secondary: #1f2937;
            --color-bg-tertiary: #374151;
            --color-bg-hover: #4b5563;
            --color-text: #f9fafb;
            --color-text-secondary: #d1d5db;
            --color-text-muted: #9ca3af;
            --color-border: #4b5563;
            --color-border-light: #374151;
            --color-primary: #06b6d4;
            --color-primary-hover: #0891b2;
            --color-primary-light: #22d3ee;
            --color-success: #10b981;
            --color-success-light: #34d399;
            --color-danger: #ef4444;
            --color-danger-light: #f87171;
            --color-warning: #f59e0b;
            --color-warning-light: #fbbf24;
        }
    </style>
</head>
<body style="background-color: var(--color-bg); color: var(--color-text);">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;
        const API_BASE_URL = '';

        // Theme management functions
        const applyTheme = (themeName) => {
            const theme = THEMES[themeName] || THEMES[DEFAULT_THEME];
            const root = document.documentElement;
            Object.entries(theme.colors).forEach(([key, value]) => {
                const cssVarName = `--color-${key.replace(/([A-Z])/g, '-$1').toLowerCase()}`;
                root.style.setProperty(cssVarName, value);
            });
            localStorage.setItem('theme', themeName);
        };

        const loadSavedTheme = () => {
            const savedTheme = localStorage.getItem('theme') || DEFAULT_THEME;
            applyTheme(savedTheme);
            return savedTheme;
        };

        // Initialize theme immediately
        loadSavedTheme();

        const fetchWithCredentials = (url, options = {}) => {
            return fetch(url, { ...options, credentials: 'include' });
        };

        // Helper function to format money input with dollar sign and commas
        const formatMoneyInput = (value) => {
            // Remove all non-digit and non-decimal characters
            let numericValue = value.replace(/[^0-9.]/g, '');

            // Ensure only one decimal point
            const parts = numericValue.split('.');
            if (parts.length > 2) {
                numericValue = parts[0] + '.' + parts.slice(1).join('');
            }

            // Limit to 2 decimal places
            if (parts.length === 2 && parts[1].length > 2) {
                numericValue = parts[0] + '.' + parts[1].substring(0, 2);
            }

            // Parse the numeric value
            const num = parseFloat(numericValue);

            // If empty or invalid, return empty string
            if (isNaN(num) || numericValue === '') {
                return '';
            }

            // Split into integer and decimal parts
            const [integerPart, decimalPart] = numericValue.split('.');

            // Add commas to integer part
            const formattedInteger = integerPart.replace(/\B(?=(\d{3})+(?!\d))/g, ',');

            // Reconstruct with dollar sign
            let formatted = '$' + formattedInteger;

            // Add decimal part if it exists
            if (decimalPart !== undefined) {
                formatted += '.' + decimalPart;
            }

            return formatted;
        };

        // Helper function to extract raw numeric value from formatted string
        const extractNumericValue = (formattedValue) => {
            const numeric = formattedValue.replace(/[^0-9.]/g, '');
            return numeric === '' ? '' : numeric;
        };

        function SetupWizard() {
            // Form state for adding new accounts
            const [newName, setNewName] = useState('');
            const [newType, setNewType] = useState('CHECKING');
            const [newBalance, setNewBalance] = useState('');
            const [newBalanceDisplay, setNewBalanceDisplay] = useState('');
            const [newCreditLimit, setNewCreditLimit] = useState('');
            const [newCreditLimitDisplay, setNewCreditLimitDisplay] = useState('');
            
            // Main state
            const [accounts, setAccounts] = useState([]);
            const [formError, setFormError] = useState('');
            const [isSubmitting, setIsSubmitting] = useState(false);
            const [hasExistingAccounts, setHasExistingAccounts] = useState(false);

            // Editing state
            const [editingAccountId, setEditingAccountId] = useState(null);
            const [editingName, setEditingName] = useState('');

            // Loading state
            const [isLoading, setIsLoading] = useState(true);
            const [connectionError, setConnectionError] = useState('');

            // Handler for balance input formatting
            const handleBalanceChange = (e) => {
                const formatted = formatMoneyInput(e.target.value);
                const numeric = extractNumericValue(formatted);
                setNewBalanceDisplay(formatted);
                setNewBalance(numeric);
            };

            // Handler for credit limit input formatting
            const handleCreditLimitChange = (e) => {
                const formatted = formatMoneyInput(e.target.value);
                const numeric = extractNumericValue(formatted);
                setNewCreditLimitDisplay(formatted);
                setNewCreditLimit(numeric);
            };

            const fetchAccounts = async () => {
                try {
                    const response = await fetchWithCredentials(`${API_BASE_URL}/api/accounts`);
                    if (!response.ok) throw new Error('Failed to fetch accounts.');
                    const data = await response.json();
                    setAccounts(data);
                    if (data.length > 0) {
                        setHasExistingAccounts(true);
                    }
                } catch (err) {
                    setConnectionError('Failed to connect to the server. Please ensure it is running and refresh the page.');
                } finally {
                    setIsLoading(false);
                }
            };
            
            useEffect(() => {
                fetchAccounts();
            }, []);

            // --- REPURPOSED: Only for initial setup user ---
            const handleAddToLocalList = (e) => {
                e.preventDefault();
                setFormError('');
                if (!newName || !newBalance) {
                    setFormError('Account Name and Balance are required.');
                    return;
                }

                // Convert balance to negative for credit cards and loans (they represent debt)
                const balanceValue = parseFloat(newBalance);
                const finalBalance = (newType === 'CREDIT_CARD' || newType === 'LOAN') ? -Math.abs(balanceValue) : balanceValue;

                const newAccount = {
                    name: newName,
                    type: newType,
                    balance: finalBalance,
                    credit_limit: newType === 'CREDIT_CARD' ? parseFloat(newCreditLimit) : null,
                };
                 setAccounts([...accounts, newAccount]);

                setNewName('');
                setNewType('CHECKING');
                setNewBalance('');
                setNewBalanceDisplay('');
                setNewCreditLimit('');
                setNewCreditLimitDisplay('');
            };
            
            // --- NEW: For existing users to add one account ---
            const handleCreateAccountOnServer = async (e) => {
                e.preventDefault();
                setFormError('');
                if (!newName || newBalance === '') {
                    setFormError('Account Name and Initial Balance are required.');
                    return;
                }

                // Convert balance to negative for credit cards and loans (they represent debt)
                const balanceValue = parseFloat(newBalance);
                const finalBalance = (newType === 'CREDIT_CARD' || newType === 'LOAN') ? -Math.abs(balanceValue) : balanceValue;

                const newAccountData = {
                    name: newName,
                    type: newType,
                    balance: finalBalance,
                    credit_limit: newType === 'CREDIT_CARD' ? parseFloat(newCreditLimit) : null,
                };

                setIsSubmitting(true);
                 try {
                    const response = await fetchWithCredentials(`${API_BASE_URL}/api/accounts`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(newAccountData),
                    });
                    if (response.ok) {
                        // Clear form and refresh account list
                        setNewName('');
                        setNewType('CHECKING');
                        setNewBalance('');
                        setNewBalanceDisplay('');
                        setNewCreditLimit('');
                        setNewCreditLimitDisplay('');
                        fetchAccounts();
                    } else {
                        const result = await response.json();
                        setFormError(result.message || 'An unknown error occurred.');
                    }
                } catch (err) {
                    setFormError('Failed to connect to the server. Is it running?');
                } finally {
                    setIsSubmitting(false);
                }
            };


            const handleFinishSetup = async () => {
                if (accounts.length === 0) {
                    setFormError('Please add at least one account to get started.');
                    return;
                }
                setIsSubmitting(true);
                setFormError('');
                try {
                    const response = await fetchWithCredentials(`${API_BASE_URL}/api/accounts/setup`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(accounts),
                    });
                    if (response.ok) {
                        window.location.href = 'index.html';
                    } else {
                        const result = await response.json();
                        setFormError(result.message || 'An unknown error occurred.');
                    }
                } catch (err) {
                    setFormError('Failed to connect to the server. Is it running?');
                } finally {
                    setIsSubmitting(false);
                }
            };

            const handleEditClick = (account) => {
                setEditingAccountId(account.account_id);
                setEditingName(account.name);
            };

            const handleCancelEdit = () => {
                setEditingAccountId(null);
                setEditingName('');
            };

            const handleUpdateAccount = async (accountId) => {
                if (!editingName) {
                    setFormError("Account name cannot be empty.");
                    return;
                }
                setIsSubmitting(true);
                setFormError('');
                try {
                    const response = await fetchWithCredentials(`${API_BASE_URL}/api/account/${accountId}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ name: editingName }),
                    });
                    if (response.ok) {
                        handleCancelEdit();
                        fetchAccounts();
                    } else {
                        const result = await response.json();
                        setFormError(result.message || 'Failed to update account.');
                    }
                } catch (err) {
                    setFormError('Failed to connect to the server.');
                } finally {
                    setIsSubmitting(false);
                }
            };

            const renderContent = () => {
                if (isLoading) {
                    return <p className="text-gray-400 text-center py-4">Loading Account Data...</p>;
                }
                if (connectionError) {
                    return <p className="text-red-400 text-center py-4 bg-red-900/50 p-4 rounded-md">{connectionError}</p>;
                }
                return (
                    <>
                        <div className="mb-6">
                            <h2 className="text-xl font-bold text-white mb-3">Your Accounts</h2>
                            {accounts.length === 0 && !hasExistingAccounts ? (
                                <p className="text-gray-500 text-center py-4">No accounts added yet.</p>
                            ) : (
                                <ul className="space-y-2">
                                    {accounts.map((acc) => (
                                        <li key={acc.account_id || acc.name} className="bg-gray-700 p-3 rounded-md flex justify-between items-center">
                                            {editingAccountId === acc.account_id ? (
                                                <div className="flex-grow flex items-center gap-2">
                                                    <input 
                                                        type="text" 
                                                        value={editingName} 
                                                        onChange={(e) => setEditingName(e.target.value)}
                                                        className="bg-gray-600 text-white p-1 rounded w-full"
                                                    />
                                                    <button onClick={() => handleUpdateAccount(acc.account_id)} className="bg-green-600 hover:bg-green-500 text-white font-bold py-1 px-3 rounded text-sm" disabled={isSubmitting}>Save</button>
                                                    <button onClick={handleCancelEdit} className="bg-gray-500 hover:bg-gray-400 text-white font-bold py-1 px-3 rounded text-sm">Cancel</button>
                                                </div>
                                            ) : (
                                                <>
                                                    <div>
                                                        <p className="font-semibold text-white">{acc.name}</p>
                                                        <p className="text-sm text-gray-400">{acc.type.replace('_', ' ')}</p>
                                                    </div>
                                                    <div className="flex items-center gap-4">
                                                        <p className="font-mono text-cyan-400">
                                                            {parseFloat(acc.balance).toLocaleString('en-US', { style: 'currency', currency: 'USD' })}
                                                        </p>
                                                        {/* Only allow editing for existing accounts with an ID */
                                                        acc.account_id && <button onClick={() => handleEditClick(acc)} className="text-xs text-cyan-400 hover:underline">Edit</button>}
                                                    </div>
                                                </>
                                            )}
                                        </li>
                                    ))}
                                </ul>
                            )}
                        </div>
                        
                        {/* --- ADD NEW ACCOUNT FORM (ALWAYS VISIBLE) --- */}
                        <div className="pt-6 border-t border-gray-700">
                             <h2 className="text-xl font-bold text-white mb-3">Add a New Account</h2>
                            <form onSubmit={hasExistingAccounts ? handleCreateAccountOnServer : handleAddToLocalList} className="grid grid-cols-1 md:grid-cols-2 gap-4 items-end bg-gray-700 p-4 rounded-md">
                                <div>
                                    <label className="block text-gray-400 mb-1 text-sm">Account Name</label>
                                    <input type="text" value={newName} onChange={(e) => setNewName(e.target.value)} className="w-full bg-gray-600 text-white p-2 rounded" placeholder="e.g., AmEx Gold"/>
                                </div>
                                <div>
                                    <label className="block text-gray-400 mb-1 text-sm">Account Type</label>
                                    <select value={newType} onChange={(e) => setNewType(e.target.value)} className="w-full bg-gray-600 text-white p-2 rounded">
                                        <option value="CHECKING">Checking</option>
                                        <option value="SAVINGS">Savings</option>
                                        <option value="CREDIT_CARD">Credit Card</option>
                                        <option value="CASH">Cash</option>
                                        <option value="LOAN">Loan</option>
                                        <option value="FIXED_ASSET">Fixed Asset</option>
                                    </select>
                                </div>
                                <div className="flex flex-col">
                                    <label className="block text-gray-400 mb-1 text-sm">
                                        {(newType === 'CREDIT_CARD' || newType === 'LOAN') ? 'Amount Owed' : 'Initial Balance'}
                                    </label>
                                    <input
                                        type="text"
                                        value={newBalanceDisplay}
                                        onInput={handleBalanceChange}
                                        className="w-full bg-gray-600 text-white p-2 rounded font-mono"
                                        placeholder={(newType === 'CREDIT_CARD' || newType === 'LOAN') ? '$1,000.00' : '$0.00'}
                                    />
                                    <div className="h-6 mt-1">
                                        {(newType === 'CREDIT_CARD' || newType === 'LOAN') && (
                                            <p className="text-xs text-gray-500">Enter as positive (e.g., $1,000.00 for $1,000 owed)</p>
                                        )}
                                    </div>
                                </div>
                                {newType === 'CREDIT_CARD' && (
                                    <div className="flex flex-col">
                                        <label className="block text-gray-400 mb-1 text-sm">Credit Limit</label>
                                        <input type="text" value={newCreditLimitDisplay} onInput={handleCreditLimitChange} className="w-full bg-gray-600 text-white p-2 rounded font-mono" placeholder="$5,000.00"/>
                                        <div className="h-6 mt-1"></div>
                                    </div>
                                )}
                                <div className="md:col-span-2">
                                    <button type="submit" className="w-full bg-cyan-600 hover:bg-cyan-500 text-white font-bold py-2 px-4 rounded" disabled={isSubmitting}>
                                        {isSubmitting ? 'Saving...' : '+ Add Account'}
                                    </button>
                                </div>
                            </form>
                        </div>


                        {formError && <p className="text-red-400 mt-4 text-center">{formError}</p>}
                        
                        <div className="mt-6">
                        {hasExistingAccounts ? (
                             <button onClick={() => window.location.href = 'index.html'} className="w-full bg-green-600 hover:bg-green-500 text-white font-bold py-3 px-4 rounded">
                                Back to Dashboard
                            </button>
                        ) : (
                            <button onClick={handleFinishSetup} disabled={isSubmitting || accounts.length === 0} className="w-full bg-green-600 hover:bg-green-500 text-white font-bold py-3 px-4 rounded disabled:bg-gray-500 disabled:cursor-not-allowed">
                                {isSubmitting ? 'Saving...' : 'Finish Setup & Go to Dashboard'}
                            </button>
                        )}
                        </div>
                    </>
                );
            };

            return (
                <div className="min-h-screen flex items-center justify-center p-4">
                    <div className="bg-gray-800 p-8 rounded-lg shadow-xl w-full max-w-2xl">
                        {hasExistingAccounts ? (
                             <>
                                <h1 className="text-3xl font-bold text-white text-center mb-2">Manage Your Accounts</h1>
                                <p className="text-gray-400 text-center mb-6">Edit account names or add new accounts below.</p>
                             </>
                        ) : (
                            <>
                                <h1 className="text-3xl font-bold text-white text-center mb-2">Welcome to Perfect Books</h1>
                                <p className="text-gray-400 text-center mb-6">Let's set up your initial financial accounts.</p>
                            </>
                        )}
                        {renderContent()}
                    </div>
                </div>
            );
        }

        ReactDOM.render(<SetupWizard />, document.getElementById('root'));
    </script>
</body>
</html>